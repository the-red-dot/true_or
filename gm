Folder: src
    File: types.d.ts
        Code:
        // src/types.d.ts
        declare module 'use-sound';

    Folder: app
        File: favicon.ico
            [Could not read file: 'utf-8' codec can't decode byte 0x96 in position 50: invalid start byte]
        File: globals.css
            Code:
            @import "tailwindcss";
            
            :root {
              --background: #ffffff;
              --foreground: #171717;
            }
            
            @theme inline {
              --color-background: var(--background);
              --color-foreground: var(--foreground);
              --font-sans: var(--font-geist-sans);
              --font-mono: var(--font-geist-mono);
            }
            
            @media (prefers-color-scheme: dark) {
              :root {
                --background: #0a0a0a;
                --foreground: #ededed;
              }
            }
            
            body {
              background: var(--background);
              color: var(--foreground);
              font-family: Arial, Helvetica, sans-serif;
            }
        File: layout.tsx
            Code:
            import type { Metadata } from "next";
            import { Geist, Geist_Mono } from "next/font/google";
            import "./globals.css";
            
            const geistSans = Geist({
              variable: "--font-geist-sans",
              subsets: ["latin"],
            });
            
            const geistMono = Geist_Mono({
              variable: "--font-geist-mono",
              subsets: ["latin"],
            });
            
            export const metadata: Metadata = {
              title: "Create Next App",
              description: "Generated by create next app",
            };
            
            export default function RootLayout({
              children,
            }: Readonly<{
              children: React.ReactNode;
            }>) {
              return (
                <html lang="en">
                  <body
                    className={`${geistSans.variable} ${geistMono.variable} antialiased`}
                  >
                    {children}
                  </body>
                </html>
              );
            }
        File: page.tsx
            Code:
            // src/app/page.tsx
            "use client";
            
            import React from "react";
            import { motion, AnimatePresence } from "framer-motion";
            import {
              Flame, Trash2, LogOut, User as UserIcon, WifiOff, RefreshCw,
              Cpu, Beer, ThumbsUp, ThumbsDown, LogIn, Play
            } from "lucide-react";
            import QRCode from "react-qr-code";
            import Link from "next/link";
            
            import { useHostGameLogic } from "@/app/hooks/useHostGameLogic";
            import { useGameSounds } from "@/app/hooks/useGameSounds";
            
            export default function TruthOrDareGame() {
              const { playSpin, playShot, playWin } = useGameSounds();
            
              const {
                gameState,
                players,
                heatLevel,
                selectedPlayer,
                lastActivePlayer,
                challengeType,
                currentChallenge,
                joinUrl,
                authUser,
                isConnected,
                reactions,
                votes,
                shotVoteMode,
                setHeatLevel,
                spinTheWheel,
                handleManualRefresh,
                handleLogout,
                endGame
              } = useHostGameLogic(playSpin, playShot, playWin);
            
              // --- Renders ---
            
              return (
                <main
                  className="h-screen w-full bg-black text-white font-sans overflow-hidden relative selection:bg-pink-500 flex flex-col"
                  dir="rtl"
                >
                  <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-900/40 via-black to-black z-0 pointer-events-none" />
            
                  {/* Top Bar */}
                  {authUser && (
                    <div className="absolute top-6 left-6 z-40 flex items-center gap-4 bg-black/40 backdrop-blur px-4 py-2 rounded-full border border-white/10">
                      <div className="flex flex-col text-left">
                        <span className="text-xs text-gray-400 font-bold uppercase">拽 专</span>
                        <span className="text-xl font-mono text-pink-500 tracking-widest">
                          {authUser.email?.split("@")[0] || "..."}
                        </span>
                      </div>
                      <div className="h-8 w-px bg-white/20"></div>
                      <div className="flex items-center gap-2">
                        <UserIcon size={16} /> {players.length}
                      </div>
                      <button onClick={handleManualRefresh} className="p-2 hover:bg-white/20 rounded-full transition-colors text-blue-400" title="专注">
                        <RefreshCw size={16} />
                      </button>
                      <button onClick={() => endGame(true)} className="p-2 hover:bg-red-500/20 rounded-full transition-colors text-red-400" title="驻住 砖拽">
                        <Trash2 size={20} />
                      </button>
                      <button onClick={handleLogout} className="p-2 hover:bg-red-500/20 rounded-full transition-colors text-red-400" title="转转拽">
                        <LogOut size={16} />
                      </button>
                      {!isConnected && <WifiOff className="text-red-500 animate-pulse" />}
                    </div>
                  )}
            
                  {/* Global Emojis Overlay (LTR for proper X positioning) */}
                  <div className="fixed inset-0 pointer-events-none z-[100] overflow-hidden" dir="ltr">
                    <AnimatePresence>
                      {reactions.map((r) => (
                        <motion.div
                          key={r.id}
                          initial={{ opacity: 0, scale: 0.5, y: "100vh", x: "-50%" }}
                          animate={{ opacity: 1, scale: [1, 1.5, 1], y: "-20vh" }}
                          exit={{ opacity: 0 }}
                          style={{ left: `${r.x}%` }}
                          transition={{ duration: 4, ease: "easeOut" }}
                          className="absolute text-7xl md:text-8xl drop-shadow-[0_0_15px_rgba(0,0,0,0.8)]"
                        >
                          {r.emoji}
                        </motion.div>
                      ))}
                    </AnimatePresence>
                  </div>
            
                  {/* Main Game Area */}
                  <div className="flex-1 flex flex-col items-center justify-center relative z-10 p-10 h-full">
                    {!authUser && (
                      <motion.div
                        initial={{ scale: 0.9, opacity: 0 }}
                        animate={{ scale: 1, opacity: 1 }}
                        className="flex flex-col items-center text-center space-y-8 p-10 bg-white/5 rounded-3xl border border-white/10 backdrop-blur-xl"
                      >
                        <div className="bg-pink-600/20 p-6 rounded-full">
                          <Trash2 className="w-20 h-20 text-pink-500 opacity-50" />
                        </div>
                        <h1 className="text-5xl font-black">砖拽 转拽</h1>
                        <p className="text-xl text-gray-400 max-w-md">
                           爪专 拽 QR 转 砖拽 砖, 注 转专 专.
                        </p>
                        <Link
                          href="/login"
                          className="px-10 py-5 bg-gradient-to-r from-pink-600 to-purple-600 rounded-2xl font-bold text-2xl shadow-xl hover:scale-105 transition-transform flex items-center gap-4"
                        >
                          <LogIn size={32} /> 转专 砖
                        </Link>
                      </motion.div>
                    )}
            
                    {authUser && (gameState === "lobby" || gameState === "waiting_for_spin") && (
                      <div className="flex flex-col items-center w-full max-w-6xl h-full justify-center">
                        <h1 className="text-8xl md:text-9xl font-black text-transparent bg-clip-text bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 drop-shadow-[0_0_30px_rgba(236,72,153,0.5)] mb-12 tracking-tighter">
                          {gameState === "lobby" ? "转  " : " 转专..."}
                        </h1>
            
                        <div className="flex flex-wrap justify-center gap-8 px-4">
                          {players.length === 0 && (
                            <div className="text-2xl text-gray-500 animate-pulse">
                              转 砖拽... 住专拽 转 拽
                            </div>
                          )}
            
                          {players.map((p) => {
                            const isController = lastActivePlayer?.id === p.id;
                            return (
                              <div key={p.id} className="relative group">
                                <div
                                  className={`w-28 h-28 rounded-full border-4 overflow-hidden transition-all duration-300 relative ${
                                    isController
                                      ? "border-yellow-400 shadow-[0_0_40px_rgba(250,204,21,0.6)] scale-110"
                                      : "border-white/20"
                                  }`}
                                >
                                  {p.avatar.startsWith("bg-") ? (
                                    <div className={`w-full h-full ${p.avatar}`} />
                                  ) : (
                                    <img src={p.avatar} className="w-full h-full object-cover" />
                                  )}
                                  {isController && (
                                    <div className="absolute inset-0 bg-black/30 flex items-center justify-center">
                                      <RefreshCw className="text-white w-10 h-10 animate-spin-slow" />
                                    </div>
                                  )}
                                </div>
                                <div className="text-center mt-2 font-bold text-lg drop-shadow-md">
                                  {p.name}
                                </div>
                                {isController && (
                                  <div className="text-center text-yellow-400 text-xs font-bold animate-pulse">
                                    拽 砖专
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
            
                        <div className="mt-12 bg-white/5 backdrop-blur-xl p-4 rounded-2xl border border-white/10 flex items-center gap-6">
                          {players.length >= 2 && (
                            <button
                              onClick={spinTheWheel}
                              className="px-6 py-3 bg-gradient-to-r from-green-600 to-green-500 rounded-xl font-bold flex items-center gap-2 hover:scale-105 transition-transform shadow-lg"
                            >
                              <Play className="fill-white" /> 转 砖拽
                            </button>
                          )}
                          <span className="text-cyan-400 font-bold flex items-center gap-2 border-r border-white/20 pr-6 mr-2">
                            <Flame /> {heatLevel}
                          </span>
                          <input
                            type="range"
                            min="1"
                            max="10"
                            value={heatLevel}
                            onChange={(e) => setHeatLevel(parseInt(e.target.value))}
                            className="w-32 accent-pink-500"
                          />
                          <button
                            onClick={() => endGame(true)}
                            className="p-2 hover:bg-red-900/50 rounded-lg text-red-300 ml-4 flex items-center gap-2"
                            title="住 砖拽"
                          >
                            <Trash2 size={20} />
                            <span className="hidden md:inline font-bold">住 砖拽</span>
                          </button>
                        </div>
                      </div>
                    )}
            
                    {authUser && gameState === "spinning" && (
                      <div className="relative">
                        <motion.div
                          animate={{ rotate: 360 * 5 }}
                          transition={{ duration: 3, ease: "circOut" }}
                          className="w-96 h-96 rounded-full border-[12px] border-dashed border-cyan-500/30 flex items-center justify-center"
                        >
                          <span className="text-9xl"></span>
                        </motion.div>
                      </div>
                    )}
            
                    {authUser && gameState === "spotlight" && selectedPlayer && (
                      <motion.div
                        initial={{ scale: 0 }}
                        animate={{ scale: 1 }}
                        className="text-center flex flex-col items-center"
                      >
                        <div className="w-72 h-72 rounded-full border-8 border-white shadow-[0_0_100px_white] overflow-hidden mb-8 relative">
                          <img src={selectedPlayer.avatar} className="w-full h-full object-cover" />
                        </div>
                        <h2 className="text-8xl font-black text-white mb-4 drop-shadow-lg">
                          {selectedPlayer.name}
                        </h2>
                        <h3 className="text-4xl font-bold text-pink-400 tracking-widest uppercase animate-pulse">
                          {selectedPlayer.gender === "female" ? "转转!" : "转转!"}
                        </h3>
                      </motion.div>
                    )}
            
                    {authUser &&
                      (gameState === "challenge" || gameState === "revealing") &&
                      currentChallenge &&
                      selectedPlayer && (
                        <div className="flex flex-col items-center justify-between h-full w-full py-10">
                          <motion.div
                            initial={{ y: 50, opacity: 0 }}
                            animate={{ y: 0, opacity: 1 }}
                            className="w-full max-w-5xl px-4 relative z-20"
                          >
                            {/* --- Active Player Avatar Header --- */}
                            <div className="absolute -top-16 left-1/2 -translate-x-1/2 z-30 flex flex-col items-center">
                               <div className="w-32 h-32 rounded-full border-4 border-white shadow-lg overflow-hidden bg-black relative z-10">
                                  <img src={selectedPlayer.avatar} className="w-full h-full object-cover" alt="Active Player" />
                               </div>
                               <div className="mt-2 bg-black/80 px-4 py-1 rounded-full text-white font-bold text-lg backdrop-blur-sm shadow-md border border-white/10">
                                  {selectedPlayer.name}
                               </div>
                            </div>
            
                            {/* --- Challenge Card --- */}
                            <div className="bg-gray-900/90 backdrop-blur-xl border border-white/20 p-12 rounded-[3rem] text-center shadow-2xl relative overflow-hidden pt-40">
                              <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-500 to-cyan-500" />
                              
                              <div className="flex justify-center mb-8">
                                <span
                                  className={`text-5xl font-black px-8 py-3 rounded-full shadow-lg ${
                                    challengeType === "转"
                                      ? "bg-blue-500/20 text-blue-400 border border-blue-500/30"
                                      : "bg-pink-500/20 text-pink-400 border border-pink-500/30"
                                  }`}
                                >
                                  {challengeType}
                                </span>
                              </div>
                              
                              <h3
                                className="text-5xl md:text-7xl font-black leading-tight mb-12 drop-shadow-lg"
                                style={{ direction: "rtl" }}
                              >
                                {currentChallenge.content}
                              </h3>
            
                              <div className="flex items-center gap-4 max-w-lg mx-auto bg-black/50 p-2 rounded-full">
                                <ThumbsUp className="text-green-500" />
                                <div className="flex-1 h-3 bg-gray-700 rounded-full overflow-hidden">
                                  <div
                                    className="bg-green-500 h-full transition-all duration-300"
                                    style={{
                                      width: `${(votes.likes / Math.max(1, players.length - 1)) * 100}%`,
                                    }}
                                  />
                                </div>
                                <div className="flex-1 h-3 bg-gray-700 rounded-full overflow-hidden flex justify-end">
                                  <div
                                    className="bg-red-500 h-full transition-all duration-300"
                                    style={{
                                      width: `${(votes.dislikes / Math.max(1, players.length - 1)) * 100}%`,
                                    }}
                                  />
                                </div>
                                <ThumbsDown className="text-red-500" />
                              </div>
            
                              {currentChallenge.usedModel && (
                                <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex items-center gap-1 text-[10px] text-gray-500 uppercase tracking-widest opacity-30">
                                  <Cpu size={10} /> <span>{currentChallenge.usedModel}</span>
                                </div>
                              )}
                            </div>
                          </motion.div>
                          
                          {/* Removed the bottom players list to keep the screen clean */}
                        </div>
                      )}
            
                    <AnimatePresence>
                      {gameState === "penalty" && (
                        <motion.div
                          initial={{ opacity: 0, scale: 0.8 }}
                          animate={{ opacity: 1, scale: 1 }}
                          exit={{ opacity: 0, scale: 1.2 }}
                          className="absolute inset-0 z-50 flex flex-col items-center justify-center bg-red-900/90 backdrop-blur-md overflow-hidden"
                        >
                          <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')] opacity-20" />
                          <motion.div
                            animate={{ rotate: [0, -10, 10, -10, 10, 0] }}
                            transition={{ duration: 0.5, repeat: Infinity, repeatDelay: 1 }}
                            className="mb-8"
                          >
                            <Beer
                              size={180}
                              className="text-yellow-400 drop-shadow-[0_0_30px_rgba(250,204,21,0.8)]"
                            />
                          </motion.div>
            
                          <h1 className="text-9xl font-black uppercase mb-4 text-white drop-shadow-[0_5px_5px_rgba(0,0,0,1)] border-4 border-white p-4">
                            SHOT!
                          </h1>
                          <h2 className="text-5xl font-bold text-red-200 mt-4">
                            {selectedPlayer?.name} 转专/转!
                          </h2>
            
                          <div className="absolute bottom-20 w-full text-center">
                            <p className="text-2xl animate-pulse text-white/70">砖拽 砖 ...</p>
                          </div>
                        </motion.div>
                      )}
                    </AnimatePresence>
            
                    <AnimatePresence>
                      {shotVoteMode && (
                        <motion.div
                          initial={{ opacity: 0 }}
                          animate={{ opacity: 1 }}
                          exit={{ opacity: 0 }}
                          className="absolute inset-0 z-[100] bg-orange-600 flex flex-col items-center justify-center"
                        >
                          <motion.div animate={{ scale: [1, 1.2, 1] }} transition={{ repeat: Infinity, duration: 0.5 }}>
                            <Beer size={200} className="mb-8 text-yellow-300" />
                          </motion.div>
                          <h1 className="text-8xl font-black text-white border-y-8 border-white py-4"> 砖转!</h1>
                          <p className="text-3xl mt-4 font-bold text-orange-200">拽 专 转 专</p>
                        </motion.div>
                      )}
                    </AnimatePresence>
            
                    {authUser && joinUrl && (
                      <div
                        className={`absolute z-30 transition-all duration-500 bg-white p-2 rounded-xl shadow-2xl ${
                          gameState === "lobby" || gameState === "waiting_for_spin"
                            ? "bottom-20 right-10 scale-125 rotate-3 hover:rotate-0"
                            : "bottom-6 right-6 scale-75 opacity-70 hover:opacity-100"
                        }`}
                      >
                        <QRCode value={joinUrl} size={gameState === "lobby" ? 120 : 100} />
                        {(gameState === "lobby" || gameState === "waiting_for_spin") && (
                          <p className="text-black text-[10px] font-black text-center mt-1 uppercase tracking-widest">
                            住专拽 爪专驻转
                          </p>
                        )}
                      </div>
                    )}
                  </div>
                </main>
              );
            }
        File: pathignore.txt
            Code:

        Folder: api

            Folder: generate
                File: route.ts
                    Code:
                    // src/app/api/generate/route.ts
                    
                    import { NextResponse } from "next/server";
                    import { createClient } from "@supabase/supabase-js";
                    
                    // 转 拽 Supabase 爪 砖专转
                    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
                    const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;
                    const supabase = createClient(supabaseUrl, supabaseKey);
                    
                    export async function POST(req: Request) {
                      try {
                        const body = await req.json();
                        // 住驻 转 players 专砖转 驻专专 砖驻 拽砖
                        const { playerName, playerGender, heatLevel, type, previousChallenges, players } = body;
                    
                        // 专 专 (转   住)
                        let dbGender = 'neutral';
                        if (playerGender === 'male') dbGender = 'male';
                        if (playerGender === 'female') dbGender = 'female';
                    
                        //  专转: 砖转 砖 +/- 1  爪 转专 转爪转
                        let minHeat = heatLevel === 1 ? 1 : heatLevel - 1;
                        let maxHeat = heatLevel === 10 ? 10 : heatLevel + 1;
                    
                        // 砖驻转 砖转 专转 -DB
                        const { data: tasks, error } = await supabase
                          .from('game_tasks')
                          .select('*')
                          .eq('type', type) // '转'  ''
                          .gte('heat_level', minHeat)
                          .lte('heat_level', maxHeat)
                          .or(`gender.eq.${dbGender},gender.eq.neutral`);
                    
                        if (error) {
                          console.error("Supabase Error:", error);
                          return NextResponse.json({
                              content: `砖转  (${type}): 住驻专 驻 砖拽专转  专!`,
                              spiciness: heatLevel,
                              themeColor: "#FF00FF",
                              usedModel: "Backup (DB Error)"
                          });
                        }
                    
                        if (!tasks || tasks.length === 0) {
                            return NextResponse.json({
                                content: ` 爪转 砖 专 ${heatLevel}...   注砖 砖 ! `,
                                spiciness: heatLevel,
                                themeColor: "#FF0000",
                                usedModel: "Database (Empty)"
                            });
                        }
                    
                        // 住 砖转 砖专  (驻 拽住 砖砖 拽)
                        const availableTasks = tasks.filter((t: any) => 
                            !previousChallenges.some((prev: string) => prev === t.content)
                        );
                    
                        //  住 转  砖转, 驻住 专  专
                        const finalPool = availableTasks.length > 0 ? availableTasks : tasks;
                    
                        // 专 专转
                        const randomTask = finalPool[Math.floor(Math.random() * finalPool.length)];
                        
                        let content = randomTask.content;
                    
                        // --- 拽转 专转 拽专 (Victim Logic) ---
                        // 专拽  砖  转 驻住专 [chosenName]
                        if (content.includes("[chosenName]") && players && players.length > 0) {
                            let victims: any[] = [];
                            
                            // 住 驻 专 驻:  拽 转, 转 拽转 
                            if (playerGender === 'male') {
                                victims = players.filter((p: any) => p.gender === 'female');
                            } else if (playerGender === 'female') {
                                victims = players.filter((p: any) => p.gender === 'male');
                            }
                    
                            //  1:   拽专转  砖 (  专 专/专), 拽  砖拽 砖  爪注 注爪
                            if (victims.length === 0) {
                                victims = players.filter((p: any) => p.name !== playerName);
                            }
                    
                            // 专转 拽专 驻转 砖 拽住
                            if (victims.length > 0) {
                                const chosenVictim = victims[Math.floor(Math.random() * victims.length)];
                                content = content.replace("[chosenName]", chosenVictim.name);
                            } else {
                                //  2 (拽专 拽爪): 砖拽    祝  专
                                content = content.replace("[chosenName]", "注爪 ( 注 砖拽)");
                            }
                        }
                    
                        return NextResponse.json({
                          content: content,
                          spiciness: randomTask.heat_level,
                          themeColor: randomTask.theme_color || '#ec4899',
                          usedModel: "Supabase DB"
                        });
                    
                      } catch (error) {
                        console.error("Critical API Error:", error);
                        return NextResponse.json(
                          { 
                              content: "转拽 转拽砖专转... 转注砖 砖!", 
                              spiciness: 1, 
                              themeColor: "#FF0000",
                              usedModel: "Error"
                          },
                          { status: 500 }
                        );
                      }
                    }

        Folder: hooks
            File: useGameSounds.ts
                Code:
                // src/hooks/useGameSounds.ts
                import { useCallback } from 'react';
                
                export const useGameSounds = () => {
                  const playSpin = useCallback(() => {
                    const audio = new Audio('/sounds/spin.mp3'); //  砖拽抓 拽 转拽转 public/sounds
                    audio.play().catch(() => console.log('Audio play failed'));
                  }, []);
                
                  const playShot = useCallback(() => {
                    const audio = new Audio('/sounds/shot.mp3'); 
                    audio.play().catch(() => console.log('Audio play failed'));
                  }, []);
                
                  const playWin = useCallback(() => {
                    const audio = new Audio('/sounds/win.mp3'); 
                    audio.play().catch(() => console.log('Audio play failed'));
                  }, []);
                
                  return { playSpin, playShot, playWin };
                };
            File: useHostGameLogic.ts
                Code:
                // src/app/hooks/useHostGameLogic.ts
                import { useState, useEffect, useRef } from "react";
                import { supabase } from "@/app/lib/supabase";
                import { User } from "@supabase/supabase-js";
                import confetti from "canvas-confetti";
                
                // --- Types ---
                export type Player = {
                  id: string;
                  created_at?: string;
                  name: string;
                  gender: "male" | "female" | "other";
                  avatar: string;
                  host_id: string;
                  user_id: string;
                  session_id?: string | null;
                  is_active?: boolean | null;
                };
                
                export type Challenge = {
                  content: string;
                  spiciness: number;
                  themeColor: string;
                  usedModel?: string;
                };
                
                export type Reaction = { id: string; emoji: string; playerId: string; x: number };
                
                export const useHostGameLogic = (
                  playSpinSound: () => void,
                  playShotSound: () => void,
                  playWinSound: () => void
                ) => {
                  // --- State ---
                  const [gameState, setGameState] = useState<
                    "lobby" | "waiting_for_spin" | "spinning" | "spotlight" | "revealing" | "challenge" | "penalty"
                  >("lobby");
                  const [players, setPlayers] = useState<Player[]>([]);
                  const [heatLevel, setHeatLevel] = useState<number>(1);
                  const [selectedPlayer, setSelectedPlayer] = useState<Player | null>(null);
                  const [lastActivePlayer, setLastActivePlayer] = useState<Player | null>(null);
                  const [challengeType, setChallengeType] = useState<"转" | "" | null>(null);
                  const [currentChallenge, setCurrentChallenge] = useState<Challenge | null>(null);
                  const [loadingAI, setLoadingAI] = useState(false);
                  const [joinUrl, setJoinUrl] = useState("");
                
                  // Auth & Connection
                  const [authUser, setAuthUser] = useState<User | null>(null);
                  const [isConnected, setIsConnected] = useState<boolean>(false);
                  const [sessionId, setSessionId] = useState<string | null>(null);
                
                  // Interactive
                  const [reactions, setReactions] = useState<Reaction[]>([]);
                  const [votes, setVotes] = useState<{ likes: number; dislikes: number; shots: number }>({
                    likes: 0,
                    dislikes: 0,
                    shots: 0,
                  });
                  const [shotVoteMode, setShotVoteMode] = useState(false);
                
                  // --- Helpers ---
                  const genSessionId = () => {
                    try {
                      if (typeof crypto !== "undefined" && crypto.randomUUID) return crypto.randomUUID();
                    } catch {}
                    return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
                  };
                
                  const resetVotes = () => {
                    setVotes({ likes: 0, dislikes: 0, shots: 0 });
                    setShotVoteMode(false);
                  };
                
                  // Prevent double-ending a round due to late/duplicated vote events
                  const roundEndLockRef = useRef(false);
                
                  // State Ref - Critical for Realtime Callbacks (avoid stale closures)
                  const stateRef = useRef({
                    players,
                    lastActivePlayer,
                    gameState,
                    sessionId,
                    selectedPlayer,
                    shotVoteMode,
                    heatLevel,
                    challengeType,
                    currentChallenge,
                    authUser,
                  });
                
                  useEffect(() => {
                    stateRef.current = {
                      players,
                      lastActivePlayer,
                      gameState,
                      sessionId,
                      selectedPlayer,
                      shotVoteMode,
                      heatLevel,
                      challengeType,
                      currentChallenge,
                      authUser,
                    };
                  }, [
                    players,
                    lastActivePlayer,
                    gameState,
                    sessionId,
                    selectedPlayer,
                    shotVoteMode,
                    heatLevel,
                    challengeType,
                    currentChallenge,
                    authUser,
                  ]);
                
                  // --- Sync Game State to DB ---
                  const syncGameStateToDB = async (args: {
                    status: string;
                    currentPlayerId: string | null;
                    controllerId: string | null;
                    heat: number;
                    sid: string | null;
                    challengeText: string | null;
                    challengeT: "转" | "" | null;
                  }) => {
                    const au = stateRef.current.authUser;
                    if (!au) return;
                
                    await supabase.from("game_states").upsert({
                      host_id: au.id,
                      session_id: args.sid,
                      status: args.status,
                      current_player_id: args.currentPlayerId,
                      last_active_player_id: args.controllerId,
                      heat_level: args.heat,
                      challenge_text: args.challengeText,
                      challenge_type: args.challengeT,
                      updated_at: new Date().toISOString(),
                    });
                  };
                
                  // Ensure controller exists in DB ASAP (fix: phone doesn't see Start Game until round 1)
                  const ensureController = (list: Player[]) => {
                    const gs = stateRef.current.gameState;
                    const sid = stateRef.current.sessionId;
                    const au = stateRef.current.authUser;
                    if (!au || !sid) return;
                    if (gs !== "lobby" && gs !== "waiting_for_spin") return;
                    if (list.length === 0) return;
                
                    const current = stateRef.current.lastActivePlayer;
                    const stillExists = current && list.some((p) => p.id === current.id);
                    const controller = stillExists ? current! : list[0];
                
                    if (!stillExists) setLastActivePlayer(controller);
                
                    // write controller to DB so players can see Start Game immediately
                    void syncGameStateToDB({
                      status: gs,
                      currentPlayerId: stateRef.current.selectedPlayer?.id ?? null,
                      controllerId: controller.id,
                      heat: stateRef.current.heatLevel,
                      sid,
                      challengeText: stateRef.current.currentChallenge?.content ?? null,
                      challengeT: stateRef.current.challengeType,
                    });
                  };
                
                  // --- 1. Auth Initialization ---
                  useEffect(() => {
                    const initAuth = async () => {
                      const {
                        data: { user },
                      } = await supabase.auth.getUser();
                      if (user) setAuthUser(user);
                    };
                    initAuth();
                
                    const { data: authListener } = supabase.auth.onAuthStateChange((event, session) => {
                      if (session?.user) {
                        setAuthUser(session.user);
                      } else {
                        setAuthUser(null);
                        setPlayers([]);
                        setSessionId(null);
                        setJoinUrl("");
                        resetVotes();
                      }
                    });
                
                    return () => {
                      authListener.subscription.unsubscribe();
                    };
                  }, []);
                
                  // --- 2. Load Game Session Data ---
                  useEffect(() => {
                    if (!authUser) return;
                
                    const loadGame = async () => {
                      const gs = await supabase.from("game_states").select("*").eq("host_id", authUser.id).single();
                
                      let currentSid: string | null = null;
                
                      if (gs.data?.session_id) {
                        const data = gs.data;
                        currentSid = data.session_id;
                        setSessionId(currentSid);
                        if (typeof data.heat_level === "number") setHeatLevel(data.heat_level);
                        if (data.status) setGameState(data.status as any);
                        if (data.challenge_type) setChallengeType(data.challenge_type as any);
                        if (data.challenge_text)
                          setCurrentChallenge({
                            content: data.challenge_text,
                            spiciness: data.heat_level,
                            themeColor: "",
                            usedModel: "Restored",
                          });
                      } else {
                        currentSid = genSessionId();
                        await supabase.from("game_states").upsert({
                          host_id: authUser.id,
                          status: "lobby",
                          heat_level: 1,
                          session_id: currentSid,
                          updated_at: new Date().toISOString(),
                        });
                        setSessionId(currentSid);
                      }
                
                      if (currentSid) {
                        const { data: loadedPlayers } = await supabase
                          .from("players")
                          .select("*")
                          .eq("host_id", authUser.id)
                          .eq("session_id", currentSid)
                          .eq("is_active", true)
                          .order("created_at", { ascending: true });
                
                        if (loadedPlayers) {
                          const list = loadedPlayers as Player[];
                          setPlayers(list);
                
                          // Restore context if needed
                          if (gs.data) {
                            if (gs.data.current_player_id) {
                              const selected = list.find((p) => p.id === gs.data.current_player_id);
                              if (selected) setSelectedPlayer(selected);
                            }
                            if (gs.data.last_active_player_id) {
                              const active = list.find((p) => p.id === gs.data.last_active_player_id);
                              if (active) setLastActivePlayer(active);
                              else if (list.length > 0) setLastActivePlayer(list[0]);
                            } else if (list.length > 0) {
                              setLastActivePlayer(list[0]);
                            }
                          } else if (list.length > 0) {
                            setLastActivePlayer(list[0]);
                          }
                
                          // IMPORTANT: make sure DB has a controller immediately
                          ensureController(list);
                        }
                      }
                    };
                
                    loadGame();
                    // eslint-disable-next-line react-hooks/exhaustive-deps
                  }, [authUser]);
                
                  // --- Actions (defined early because realtime handlers use them) ---
                  const handleManualRefresh = async () => {
                    const au = stateRef.current.authUser;
                    const sid = stateRef.current.sessionId;
                    if (!au || !sid) return;
                
                    const { data } = await supabase
                      .from("players")
                      .select("*")
                      .eq("host_id", au.id)
                      .eq("session_id", sid)
                      .eq("is_active", true)
                      .order("created_at", { ascending: true });
                
                    if (data) {
                      setPlayers(data as Player[]);
                      ensureController(data as Player[]);
                    }
                  };
                
                  const triggerGroupShot = () => {
                    if (roundEndLockRef.current) return;
                    roundEndLockRef.current = true;
                
                    setShotVoteMode(true);
                    playShotSound();
                
                    setTimeout(() => {
                      setShotVoteMode(false);
                      setGameState("waiting_for_spin");
                      setSelectedPlayer(null);
                    }, 5000);
                  };
                
                  const handleDone = () => {
                    if (roundEndLockRef.current) return;
                    roundEndLockRef.current = true;
                
                    confetti({ particleCount: 200, spread: 120 });
                    playWinSound();
                
                    const sp = stateRef.current.selectedPlayer;
                    setLastActivePlayer(sp ?? null);
                
                    setTimeout(() => {
                      setGameState("waiting_for_spin");
                      setSelectedPlayer(null);
                    }, 3000);
                  };
                
                  const handleSkip = () => {
                    if (roundEndLockRef.current) return;
                    roundEndLockRef.current = true;
                
                    setGameState("penalty");
                    playShotSound();
                
                    const sp = stateRef.current.selectedPlayer;
                    setTimeout(() => {
                      setLastActivePlayer(sp ?? null);
                      setGameState("waiting_for_spin");
                      setSelectedPlayer(null);
                    }, 5000);
                  };
                
                  const spinTheWheel = () => {
                    const { players: currentPlayers, gameState: gs } = stateRef.current;
                
                    if (currentPlayers.length < 2) {
                      void handleManualRefresh();
                      if (stateRef.current.players.length < 2) return alert("爪专 驻转 2 砖拽  转!");
                    }
                
                    if (gs !== "lobby" && gs !== "waiting_for_spin") return;
                
                    // new round starts
                    roundEndLockRef.current = false;
                    resetVotes();
                
                    setGameState("spinning");
                    playSpinSound();
                
                    setTimeout(() => {
                      const freshPlayers = stateRef.current.players;
                      if (freshPlayers.length === 0) return setGameState("lobby");
                
                      const randomPlayer = freshPlayers[Math.floor(Math.random() * freshPlayers.length)];
                      setSelectedPlayer(randomPlayer);
                      setChallengeType(Math.random() > 0.5 ? "转" : "");
                      setGameState("spotlight");
                    }, 3000);
                  };
                
                  // --- Handlers ---
                  const handleGameEvent = (data: any) => {
                    const { type, payload, playerId } = data;
                    const gs = stateRef.current.gameState;
                
                    if (type === "emoji") {
                      const id = Math.random().toString(36);
                      const randomX = Math.random() * 80 + 10;
                      setReactions((prev) => [...prev, { id, emoji: payload, playerId, x: randomX }]);
                      setTimeout(() => setReactions((prev) => prev.filter((r) => r.id !== id)), 4000);
                      return;
                    }
                
                    if (type === "update_heat") {
                      setHeatLevel(payload);
                      return;
                    }
                
                    if (type === "trigger_spin") {
                      spinTheWheel();
                      return;
                    }
                
                    if (type === "player_left") {
                      setPlayers((prev) => {
                        const next = prev.filter((p) => p.id !== playerId);
                        // if controller left during lobby/waiting, pick a new one and sync
                        ensureController(next);
                        return next;
                      });
                      return;
                    }
                
                    // IMPORTANT FIX:
                    // Ignore voting/skip events unless we are currently in CHALLENGE.
                    // This prevents "phantom" confetti / group shot triggered by votes sent during waiting/spinning/revealing.
                    if (gs !== "challenge") return;
                
                    if (type === "action_skip") {
                      handleSkip();
                      return;
                    }
                
                    if (type === "vote_like") {
                      setVotes((v) => ({ ...v, likes: v.likes + 1 }));
                      return;
                    }
                
                    if (type === "vote_dislike") {
                      setVotes((v) => ({ ...v, dislikes: v.dislikes + 1 }));
                      return;
                    }
                
                    if (type === "vote_shot") {
                      setVotes((v) => {
                        const newShots = v.shots + 1;
                        const threshold = Math.max(2, Math.floor(stateRef.current.players.length / 2));
                        if (newShots >= threshold && !stateRef.current.shotVoteMode) triggerGroupShot();
                        return { ...v, shots: newShots };
                      });
                      return;
                    }
                  };
                
                  // --- 3. Realtime Subscriptions (Starts ONLY after SessionID is ready) ---
                  useEffect(() => {
                    if (!authUser || !sessionId) return;
                
                    const hostId = authUser.id;
                
                    const gsChannel = supabase
                      .channel(`gamestate_host_${hostId}`)
                      .on(
                        "postgres_changes",
                        { event: "UPDATE", schema: "public", table: "game_states", filter: `host_id=eq.${hostId}` },
                        (payload) => {
                          const next = payload.new as any;
                          const nextSid: string | null = next?.session_id ?? null;
                
                          if (nextSid && nextSid !== stateRef.current.sessionId) {
                            setSessionId(nextSid);
                            setPlayers([]);
                            setGameState("lobby");
                            resetVotes();
                            return;
                          }
                
                          if (next.status) setGameState(next.status);
                          if (typeof next.heat_level === "number") setHeatLevel(next.heat_level);
                
                          if (next.current_player_id) {
                            const p = stateRef.current.players.find((p) => p.id === next.current_player_id);
                            if (p && p.id !== stateRef.current.selectedPlayer?.id) setSelectedPlayer(p);
                          }
                          if (next.last_active_player_id) {
                            const lp = stateRef.current.players.find((p) => p.id === next.last_active_player_id);
                            if (lp && lp.id !== stateRef.current.lastActivePlayer?.id) setLastActivePlayer(lp);
                          }
                        }
                      )
                      .subscribe();
                
                    const roomChannel = supabase
                      .channel(`room_${hostId}`)
                      .on(
                        "postgres_changes",
                        { event: "INSERT", schema: "public", table: "players", filter: `host_id=eq.${hostId}` },
                        (payload) => {
                          const np = payload.new as any;
                          const sidNow = stateRef.current.sessionId;
                
                          if (np.session_id === sidNow && np.is_active) {
                            setPlayers((prev) => {
                              const next = prev.some((p) => p.id === np.id) ? prev : [...prev, np];
                              ensureController(next);
                              return next;
                            });
                          }
                        }
                      )
                      .on(
                        "postgres_changes",
                        { event: "UPDATE", schema: "public", table: "players", filter: `host_id=eq.${hostId}` },
                        (payload) => {
                          const up = payload.new as any;
                          const sidNow = stateRef.current.sessionId;
                
                          setPlayers((prev) => {
                            let next: Player[];
                            if (up.session_id !== sidNow || !up.is_active) {
                              next = prev.filter((p) => p.id !== up.id);
                            } else {
                              const exists = prev.some((p) => p.id === up.id);
                              next = exists ? prev.map((p) => (p.id === up.id ? up : p)) : [...prev, up];
                            }
                            ensureController(next);
                            return next;
                          });
                        }
                      )
                      .on(
                        "postgres_changes",
                        { event: "DELETE", schema: "public", table: "players", filter: `host_id=eq.${hostId}` },
                        (payload) => {
                          const deletedId = (payload.old as any)?.id;
                          if (!deletedId) return;
                          setPlayers((prev) => {
                            const next = prev.filter((p) => p.id !== deletedId);
                            ensureController(next);
                            return next;
                          });
                        }
                      )
                      .on("broadcast", { event: "game_event" }, (event) => handleGameEvent(event.payload))
                      .subscribe((status) => {
                        setIsConnected(status === "SUBSCRIBED");
                      });
                
                    return () => {
                      supabase.removeChannel(gsChannel);
                      supabase.removeChannel(roomChannel);
                    };
                  }, [authUser, sessionId]);
                
                  // --- DB Sync (Debounced) ---
                  useEffect(() => {
                    if (!authUser || !sessionId) return;
                
                    const controllerId =
                      lastActivePlayer?.id ?? (players.length > 0 ? players[0].id : null);
                
                    const t = setTimeout(() => {
                      void syncGameStateToDB({
                        status: gameState,
                        currentPlayerId: selectedPlayer?.id ?? null,
                        controllerId,
                        heat: heatLevel,
                        sid: sessionId,
                        challengeText: currentChallenge?.content ?? null,
                        challengeT: challengeType,
                      });
                    }, 120);
                
                    return () => clearTimeout(t);
                  }, [
                    authUser,
                    sessionId,
                    gameState,
                    selectedPlayer?.id,
                    lastActivePlayer?.id,
                    players.length,
                    heatLevel,
                    challengeType,
                    currentChallenge?.content,
                  ]);
                
                  // Reset votes when leaving challenge AND also when entering a new round stage
                  useEffect(() => {
                    if (gameState !== "challenge") {
                      resetVotes();
                    } else {
                      // entering challenge: start clean + unlock end-of-round
                      roundEndLockRef.current = false;
                      resetVotes();
                    }
                    // eslint-disable-next-line react-hooks/exhaustive-deps
                  }, [gameState, sessionId]);
                
                  // URL setup
                  useEffect(() => {
                    if (authUser && typeof window !== "undefined") {
                      setJoinUrl(`${window.location.origin}/join?hostId=${authUser.id}`);
                    }
                  }, [authUser]);
                
                  // Auto votes (only meaningful in challenge; guarded by roundEndLockRef)
                  useEffect(() => {
                    if (gameState !== "challenge") return;
                    if (roundEndLockRef.current) return;
                
                    const voters = Math.max(1, players.length - 1);
                    if (votes.likes > voters * 0.5) handleDone();
                    else if (votes.dislikes > voters * 0.5) handleSkip();
                  }, [votes, players.length, gameState]);
                
                  useEffect(() => {
                    if (gameState === "spotlight") {
                      const t = setTimeout(() => setGameState("revealing"), 3000);
                      return () => clearTimeout(t);
                    }
                  }, [gameState]);
                
                  // AI Generation
                  useEffect(() => {
                    if (gameState === "revealing" && selectedPlayer && challengeType && authUser) {
                      setLoadingAI(true);
                      fetch("/api/generate", {
                        method: "POST",
                        body: JSON.stringify({
                          playerName: selectedPlayer.name,
                          playerGender: selectedPlayer.gender,
                          players: players,
                          heatLevel: heatLevel,
                          type: challengeType,
                          previousChallenges: [],
                        }),
                      })
                        .then((res) => res.json())
                        .then((data) => {
                          setCurrentChallenge(data);
                          setGameState("challenge");
                        })
                        .catch((err) => {
                          console.error(err);
                          setGameState("challenge");
                        })
                        .finally(() => setLoadingAI(false));
                    }
                  }, [gameState, authUser, selectedPlayer, challengeType, players, heatLevel]);
                
                  const endGame = async (askConfirm = true) => {
                    const au = stateRef.current.authUser;
                    if (!au) return;
                    if (askConfirm && !confirm("住 砖拽 转 砖?")) return;
                
                    await supabase.from("players").delete().eq("host_id", au.id);
                
                    const newSid = genSessionId();
                
                    await supabase.from("game_states").upsert({
                      host_id: au.id,
                      session_id: newSid,
                      status: "lobby",
                      current_player_id: null,
                      last_active_player_id: null,
                      challenge_text: null,
                      challenge_type: null,
                      heat_level: 1,
                      updated_at: new Date().toISOString(),
                    });
                
                    setSessionId(newSid);
                    setPlayers([]);
                    setGameState("lobby");
                    setLastActivePlayer(null);
                    setSelectedPlayer(null);
                    setCurrentChallenge(null);
                    setChallengeType(null);
                    setHeatLevel(1);
                    resetVotes();
                    roundEndLockRef.current = false;
                  };
                
                  const handleLogout = async () => {
                    if (confirm("转转拽?")) await supabase.auth.signOut();
                  };
                
                  return {
                    gameState,
                    players,
                    heatLevel,
                    selectedPlayer,
                    lastActivePlayer,
                    challengeType,
                    currentChallenge,
                    joinUrl,
                    authUser,
                    isConnected,
                    reactions,
                    votes,
                    shotVoteMode,
                    setHeatLevel,
                    spinTheWheel,
                    handleManualRefresh,
                    handleLogout,
                    endGame,
                  };
                };
            File: usePlayerGameLogic.ts
                Code:
                // src/hooks/usePlayerGameLogic.ts
                import { useState, useEffect, useRef } from "react";
                import { supabase } from "@/app/lib/supabase";
                import { RealtimeChannel, User } from "@supabase/supabase-js";
                
                // --- Types ---
                export type GameStateRow = {
                  host_id: string;
                  status: string | null;
                  current_player_id: string | null;
                  last_active_player_id: string | null;
                  heat_level: number | null;
                  challenge_text: string | null;
                  challenge_type: string | null;
                  session_id: string | null;
                };
                
                export type PlayerRow = {
                  id: string;
                  host_id: string;
                  user_id: string;
                  name: string;
                  gender: "male" | "female" | "other";
                  avatar: string;
                  is_active: boolean | null;
                  session_id: string | null;
                };
                
                export const usePlayerGameLogic = (hostId: string | null) => {
                  // Registration State
                  const [name, setName] = useState("");
                  const [gender, setGender] = useState<"male" | "female" | "other" | "">("");
                  const [imagePreview, setImagePreview] = useState<string | null>(null);
                  const [isSubmitted, setIsSubmitted] = useState(false);
                  const [loading, setLoading] = useState(false);
                
                  // Auth / status
                  const [authUser, setAuthUser] = useState<User | null>(null);
                  const [authReady, setAuthReady] = useState(false);
                
                  // Game Logic State
                  const [myPlayerId, setMyPlayerId] = useState<string | null>(null);
                  const [gameState, setGameState] = useState<GameStateRow | null>(null);
                  const [localHeat, setLocalHeat] = useState(1);
                
                  // Refs
                  const myPlayerIdRef = useRef<string | null>(null);
                  const myUserIdRef = useRef<string | null>(null);
                  const sessionIdRef = useRef<string | null>(null);
                  const broadcastRef = useRef<RealtimeChannel | null>(null);
                
                  // Prevent "ghost taps"/multi-send when channel isn't ready yet
                  const pendingActionRef = useRef<{ type: string; payload: any } | null>(null);
                
                  // Small UX guards (do not affect responsiveness)
                  const heatDebounceRef = useRef<number | null>(null);
                  const spinLockRef = useRef(false);
                  const voteLockRef = useRef(false);
                
                  useEffect(() => {
                    myPlayerIdRef.current = myPlayerId;
                  }, [myPlayerId]);
                
                  // --- Helpers ---
                  const handleKicked = (opts?: { keepInputs?: boolean }) => {
                    if (hostId) localStorage.removeItem(`player_id_${hostId}`);
                
                    // Clear pending/locks so nothing "fires later"
                    pendingActionRef.current = null;
                    spinLockRef.current = false;
                    voteLockRef.current = false;
                    if (heatDebounceRef.current) {
                      window.clearTimeout(heatDebounceRef.current);
                      heatDebounceRef.current = null;
                    }
                
                    setMyPlayerId(null);
                    setIsSubmitted(false);
                  };
                
                  const compressImage = (file: File): Promise<string> => {
                    return new Promise((resolve) => {
                      const reader = new FileReader();
                      reader.readAsDataURL(file);
                      reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target?.result as string;
                        img.onload = () => {
                          const canvas = document.createElement("canvas");
                          const maxWidth = 300;
                          const scaleSize = maxWidth / img.width;
                          canvas.width = maxWidth;
                          canvas.height = img.height * scaleSize;
                          const ctx = canvas.getContext("2d");
                          ctx?.drawImage(img, 0, 0, canvas.width, canvas.height);
                          resolve(canvas.toDataURL("image/jpeg", 0.7));
                        };
                      };
                    });
                  };
                
                  // --- Effects ---
                
                  // 1. Auth
                  useEffect(() => {
                    if (!hostId) return;
                    (async () => {
                      try {
                        const { data: s0 } = await supabase.auth.getSession();
                        if (!s0.session) await supabase.auth.signInAnonymously();
                        const { data: u } = await supabase.auth.getUser();
                        setAuthUser(u.user ?? null);
                        myUserIdRef.current = u.user?.id ?? null;
                      } catch (e) {
                        console.error("Auth failed:", e);
                      } finally {
                        setAuthReady(true);
                      }
                    })();
                  }, [hostId]);
                
                  // 2. Load Initial Game State
                  useEffect(() => {
                    if (!hostId) return;
                    supabase
                      .from("game_states")
                      .select("*")
                      .eq("host_id", hostId)
                      .single()
                      .then(({ data, error }) => {
                        if (error) {
                          setGameState(null);
                          sessionIdRef.current = null;
                          return;
                        }
                        const gs = data as GameStateRow;
                        setGameState(gs);
                        sessionIdRef.current = gs.session_id ?? null;
                        setLocalHeat(gs.heat_level ?? 1);
                      });
                  }, [hostId]);
                
                  // 3. Realtime Listeners (Unified)
                  useEffect(() => {
                    if (!hostId) return;
                
                    // We create one broadcast channel for interactions
                    const bc = supabase.channel(`room_${hostId}`, {
                      config: {
                        broadcast: { self: false },
                      },
                    });
                
                    bc.subscribe((status) => {
                      if (status === "SUBSCRIBED") {
                        broadcastRef.current = bc;
                        console.log("Broadcast channel connected for player");
                
                        // Flush only the latest pending action (prevents stacked "auto clicks")
                        const pending = pendingActionRef.current;
                        if (pending) {
                          pendingActionRef.current = null;
                          // fire once, now that the channel is ready
                          void sendAction(pending.type, pending.payload);
                        }
                      }
                    });
                
                    // Separate channels for DB changes to avoid filter conflicts
                    const gameStateChannel = supabase
                      .channel(`gamestate_listener_${hostId}`)
                      .on(
                        "postgres_changes",
                        { event: "UPDATE", schema: "public", table: "game_states", filter: `host_id=eq.${hostId}` },
                        (payload) => {
                          const next = payload.new as GameStateRow;
                          setGameState(next);
                          setLocalHeat(next.heat_level ?? 1);
                
                          const nextSession = next.session_id ?? null;
                          if (nextSession && nextSession !== sessionIdRef.current) {
                            sessionIdRef.current = nextSession;
                            if (myPlayerIdRef.current) handleKicked({ keepInputs: true });
                          }
                
                          // Optional: unlock vote on new challenge text / leaving challenge state
                          // This is a lightweight guard against duplicate vote sends on mobile.
                          if (next.status !== "challenge") {
                            voteLockRef.current = false;
                          }
                        }
                      )
                      .subscribe();
                
                    const playersChannel = supabase
                      .channel(`players_listener_${hostId}`)
                      .on(
                        "postgres_changes",
                        { event: "UPDATE", schema: "public", table: "players", filter: `host_id=eq.${hostId}` },
                        (payload) => {
                          const next = payload.new as PlayerRow;
                          const myUid = myUserIdRef.current;
                          if (!myUid) return;
                          if (next.user_id === myUid) {
                            const curSession = sessionIdRef.current;
                            const isWrongSession = curSession && next.session_id !== curSession;
                            const isInactive = next.is_active === false;
                            if (isWrongSession || isInactive) handleKicked({ keepInputs: true });
                          }
                        }
                      )
                      .on(
                        "postgres_changes",
                        { event: "DELETE", schema: "public", table: "players", filter: `host_id=eq.${hostId}` },
                        (payload) => {
                          const deletedId = (payload.old as any)?.id;
                          if (deletedId && deletedId === myPlayerIdRef.current) handleKicked({ keepInputs: true });
                        }
                      )
                      .subscribe();
                
                    return () => {
                      // Cleanup timers
                      if (heatDebounceRef.current) {
                        window.clearTimeout(heatDebounceRef.current);
                        heatDebounceRef.current = null;
                      }
                
                      // Cleanup channels
                      supabase.removeChannel(bc);
                      broadcastRef.current = null;
                      supabase.removeChannel(gameStateChannel);
                      supabase.removeChannel(playersChannel);
                    };
                    // eslint-disable-next-line react-hooks/exhaustive-deps
                  }, [hostId]);
                
                  // 4. Restore Session
                  useEffect(() => {
                    if (!hostId || !authReady) return;
                    const myUid = myUserIdRef.current;
                    const sessionId = sessionIdRef.current;
                    if (!myUid || !sessionId) return;
                
                    (async () => {
                      const { data } = await supabase
                        .from("players")
                        .select("id,name,gender,avatar,is_active,session_id")
                        .eq("host_id", hostId)
                        .eq("user_id", myUid)
                        .eq("session_id", sessionId)
                        .maybeSingle();
                
                      if (data && (data as any).is_active !== false) {
                        const p = data as PlayerRow;
                        setMyPlayerId(p.id);
                        setIsSubmitted(true);
                        setName(p.name);
                        setGender(p.gender);
                        setImagePreview(p.avatar);
                      }
                    })();
                  }, [hostId, authReady, gameState?.session_id]);
                
                  // --- Actions ---
                  const sendAction = async (type: string, payload: any = {}) => {
                    if (!hostId || !myPlayerIdRef.current) {
                      console.warn("Cannot send action: Missing hostId or playerId");
                      return;
                    }
                
                    const channel = broadcastRef.current;
                
                    // If channel isn't ready, store only the latest action (no recursive retries!)
                    if (!channel) {
                      pendingActionRef.current = { type, payload };
                      return;
                    }
                
                    try {
                      await channel.send({
                        type: "broadcast",
                        event: "game_event",
                        payload: { type, payload, playerId: myPlayerIdRef.current },
                      });
                    } catch (err) {
                      console.error("Error sending action:", err);
                    }
                  };
                
                  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
                    const file = e.target.files?.[0];
                    if (!file) return;
                    try {
                      const compressed = await compressImage(file);
                      setImagePreview(compressed);
                    } catch {
                      alert("砖 转");
                    }
                  };
                
                  const handleJoin = async () => {
                    if (!name || !gender) return alert("住专 砖  ");
                    if (!hostId) return alert("拽 砖拽 砖");
                    const sessionId = sessionIdRef.current;
                    if (!sessionId) return alert("专   注. 转 砖专 转专.");
                
                    setLoading(true);
                    try {
                      const { data: u } = await supabase.auth.getUser();
                      const userId = u.user?.id;
                      if (!userId) throw new Error("No user");
                
                      const { data, error } = await supabase
                        .from("players")
                        .upsert(
                          [
                            {
                              host_id: hostId,
                              user_id: userId,
                              session_id: sessionId,
                              is_active: true,
                              name,
                              gender,
                              avatar: imagePreview ?? "bg-pink-500",
                            },
                          ],
                          { onConflict: "host_id,user_id" }
                        )
                        .select("id")
                        .single();
                
                      if (error) throw error;
                
                      setMyPlayerId(data.id);
                      setIsSubmitted(true);
                    } catch (e: any) {
                      console.error(e);
                      alert("砖 爪专驻转");
                    } finally {
                      setLoading(false);
                    }
                  };
                
                  const handleLeaveGame = async () => {
                    if (!confirm("爪转 砖拽?")) return;
                    const pid = myPlayerIdRef.current;
                    const myUid = myUserIdRef.current;
                    if (!pid || !myUid) return;
                
                    await sendAction("player_left");
                    await supabase.from("players").update({ is_active: false }).eq("id", pid).eq("user_id", myUid);
                    handleKicked({ keepInputs: true });
                  };
                
                  const handleSpin = () => {
                    if (spinLockRef.current) return;
                    spinLockRef.current = true;
                
                    void sendAction("trigger_spin");
                
                    // short lock to prevent double-tap / accidental multi-send
                    window.setTimeout(() => {
                      spinLockRef.current = false;
                    }, 800);
                  };
                
                  const handleHeatChange = (val: number) => {
                    setLocalHeat(val);
                
                    // Debounce to reduce spam + prevent weird queued events
                    if (heatDebounceRef.current) window.clearTimeout(heatDebounceRef.current);
                    heatDebounceRef.current = window.setTimeout(() => {
                      void sendAction("update_heat", val);
                    }, 120);
                  };
                
                  const sendEmoji = (icon: string) => {
                    void sendAction("emoji", icon);
                  };
                
                  const sendVote = (type: "vote_like" | "vote_dislike" | "vote_shot" | "action_skip") => {
                    // lightweight guard against rapid double taps
                    if (voteLockRef.current) return;
                    voteLockRef.current = true;
                
                    void sendAction(type);
                
                    window.setTimeout(() => {
                      voteLockRef.current = false;
                    }, 600);
                  };
                
                  return {
                    // State
                    name,
                    setName,
                    gender,
                    setGender,
                    imagePreview,
                    handleImageUpload,
                    isSubmitted,
                    loading,
                    authReady,
                    authUser,
                    gameState,
                    localHeat,
                    myPlayerId,
                
                    // Actions
                    handleJoin,
                    handleLeaveGame,
                    handleSpin,
                    handleHeatChange,
                    sendEmoji,
                    sendVote,
                  };
                };

        Folder: join
            File: page.tsx
                Code:
                // src/app/join/page.tsx
                "use client";
                
                import React, { Suspense } from "react";
                import { motion } from "framer-motion";
                import {
                  Camera, Loader2, AlertTriangle, Beer, XCircle, Flame, RefreshCw, LogOut
                } from "lucide-react";
                import { useSearchParams } from "next/navigation";
                // 注转 转 转 驻 拽 砖 砖爪转
                import { usePlayerGameLogic } from "@/app/hooks/usePlayerGameLogic";
                
                function GameController() {
                  const searchParams = useSearchParams();
                  const hostId = searchParams.get("hostId");
                
                  // 砖砖 -Hook 砖 砖
                  const {
                    name, setName,
                    gender, setGender,
                    imagePreview, handleImageUpload,
                    isSubmitted,
                    loading,
                    authReady,
                    authUser,
                    gameState,
                    localHeat,
                    myPlayerId,
                    handleJoin,
                    handleLeaveGame,
                    handleSpin,
                    handleHeatChange,
                    sendEmoji,
                    sendVote
                  } = usePlayerGameLogic(hostId);
                
                  // --- Render Functions ---
                
                  // 1. Error State
                  if (!hostId) {
                    return (
                      <div className="text-white p-10 text-center flex flex-col items-center justify-center h-screen bg-black" dir="rtl">
                        <AlertTriangle size={48} className="text-red-500 mb-4" />
                        拽 砖拽 砖
                      </div>
                    );
                  }
                
                  const isAnonymous = (authUser as any)?.is_anonymous === true;
                
                  // 2. Controller View (Active Game)
                  if (isSubmitted && myPlayerId && gameState) {
                    const isMyTurnToPlay = gameState.current_player_id === myPlayerId;
                    const isMyTurnToSpin =
                      gameState.last_active_player_id === myPlayerId &&
                      (gameState.status === "lobby" || gameState.status === "waiting_for_spin");
                
                    return (
                      <div className="fixed inset-0 bg-gray-900 text-white flex flex-col overflow-hidden" dir="rtl">
                        {/* Header */}
                        <div className="pt-4 px-4 pb-2 bg-gray-800/50 backdrop-blur-md border-b border-gray-700/50 flex justify-between items-center z-10">
                          <div className="flex items-center gap-3">
                            {imagePreview && <img src={imagePreview} className="w-8 h-8 rounded-full object-cover border border-white" />}
                            <span className="font-bold truncate max-w-[140px]">{name}</span>
                          </div>
                          <div className="flex gap-2 items-center">
                            <div className="text-[10px] px-2 py-1 bg-green-500/20 text-green-400 rounded-full border border-green-500/30 flex items-center">
                              {isAnonymous ? "专 " : "专"}
                            </div>
                            <button onClick={handleLeaveGame} className="p-1 bg-red-500/20 text-red-400 rounded-lg" title="爪 砖拽">
                              <LogOut size={16} />
                            </button>
                          </div>
                        </div>
                
                        {/* Main Content */}
                        <div className="flex-1 flex flex-col justify-center items-center p-6 relative w-full max-w-md mx-auto overflow-y-auto">
                          {/* SPIN CONTROLS */}
                          {isMyTurnToSpin ? (
                            <motion.div initial={{ scale: 0.8, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} className="w-full space-y-6">
                              <div className="text-center">
                                <h2 className="text-3xl font-black mb-1 text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-500">
                                  {gameState.status === "lobby" ? "转 转!" : "砖专 爪!"}
                                </h2>
                                <p className="text-gray-400 text-sm">专 专转  住</p>
                              </div>
                
                              <div className="bg-gray-800/80 p-5 rounded-3xl border border-gray-700 shadow-xl">
                                <div className="flex justify-between items-center mb-4">
                                  <span className="flex items-center gap-2 font-bold text-xl text-orange-400">
                                    <Flame className="fill-orange-400" /> {localHeat}
                                  </span>
                                  <span className="text-xs text-gray-400 uppercase tracking-widest">
                                    {localHeat < 4 ? "拽" : localHeat < 8 ? "" : "拽住专"}
                                  </span>
                                </div>
                                <input
                                  type="range"
                                  min="1"
                                  max="10"
                                  step="1"
                                  value={localHeat}
                                  onChange={(e) => handleHeatChange(parseInt(e.target.value))}
                                  className="w-full h-8 bg-gray-700 rounded-full appearance-none cursor-pointer accent-pink-500"
                                />
                              </div>
                
                              <button
                                onClick={handleSpin}
                                className="w-full py-6 bg-gradient-to-r from-pink-600 to-purple-600 rounded-3xl font-black text-3xl shadow-[0_0_30px_rgba(236,72,153,0.4)] active:scale-95 transition-transform flex items-center justify-center gap-3"
                              >
                                <RefreshCw size={32} className="animate-spin-slow" />{" "}
                                {gameState.status === "lobby" ? "转 砖拽" : "住!"}
                              </button>
                            </motion.div>
                          ) : (
                            <div className="w-full space-y-6">
                              {/* Active Player Controls */}
                              {isMyTurnToPlay && gameState.status === "challenge" && (
                                <motion.div initial={{ y: 20, opacity: 0 }} animate={{ y: 0, opacity: 1 }} className="w-full">
                                  <div className="bg-gray-800/90 p-6 rounded-3xl border-2 border-pink-500 shadow-2xl mb-4 text-center">
                                    <h2 className="text-3xl font-black text-pink-400 mb-2">转专!</h2>
                                    <p className="text-white/80 text-lg">{gameState.challenge_type}</p>
                                  </div>
                
                                  <button
                                    onClick={() => sendVote("action_skip")}
                                    className="w-full py-5 bg-red-500/20 hover:bg-red-500/30 text-red-200 border-2 border-red-500 rounded-2xl font-bold text-xl flex items-center justify-center gap-3 active:scale-95 transition-all"
                                  >
                                    <XCircle />  转专 (砖!)
                                  </button>
                                  <p className="text-center text-xs text-gray-500 mt-2">爪 转注专 转 转专</p>
                                </motion.div>
                              )}
                
                              {/* Spectator View */}
                              {!isMyTurnToPlay && gameState.status === "challenge" && (
                                <div className="bg-gray-800/50 p-4 rounded-2xl border border-gray-700">
                                  <h3 className="text-center font-bold mb-4 text-gray-300"> 注转 注 爪注?</h3>
                                  <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => sendVote("vote_like")} className="bg-green-600/80 p-4 rounded-xl flex justify-center active:scale-95 text-2xl hover:bg-green-500 transition-colors"></button>
                                    <button onClick={() => sendVote("vote_dislike")} className="bg-red-600/80 p-4 rounded-xl flex justify-center active:scale-95 text-2xl hover:bg-red-500 transition-colors"></button>
                                  </div>
                                  <button onClick={() => sendVote("vote_shot")} className="w-full mt-3 bg-orange-600/80 p-3 rounded-xl font-bold flex justify-center items-center gap-2 active:scale-95 hover:bg-orange-500 transition-colors">
                                    <Beer size={18} />  砖转!
                                  </button>
                                </div>
                              )}
                
                              {/* Waiting states */}
                              {gameState.status !== "challenge" && (
                                <div className="text-center text-gray-400 animate-pulse">
                                  {gameState.status === "spinning" && <div className="text-6xl animate-spin mb-4"></div>}
                                  <p className="text-xl font-bold">
                                    {gameState.status === "lobby" ? "转 专..." :
                                     gameState.status === "waiting_for_spin" ? "转 住..." :
                                     gameState.status === "spinning" ? "专..." :
                                     gameState.status === "penalty" ? "砖!" : "砖拽 专抓 ..."}
                                  </p>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                
                        {/* Emoji Bar */}
                        <div className="w-full pt-3 pb-6 bg-gray-900 border-t border-gray-800 z-10">
                          <p className="text-center text-[10px] text-gray-500 mb-2 font-bold uppercase tracking-widest">转 专</p>
                          <div className="flex justify-between gap-2 overflow-x-auto pb-2 scrollbar-hide px-2">
                            {[{ icon: "" }, { icon: "" }, { icon: "" }, { icon: "あ" }, { icon: "" }, { icon: "" }, { icon: "" }].map(
                              (item, idx) => (
                                <button
                                  key={idx}
                                  onClick={() => sendEmoji(item.icon)}
                                  className="bg-gray-800 p-3 rounded-2xl text-2xl active:scale-75 transition-transform shadow-md border border-gray-700 flex-shrink-0 hover:bg-gray-700"
                                >
                                  {item.icon}
                                </button>
                              )
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  }
                
                  // 3. Registration View
                  return (
                    <div className="min-h-[100dvh] bg-black text-white p-6 flex flex-col items-center justify-center text-center" dir="rtl">
                      <div className="w-full max-w-sm space-y-6">
                        <div className="flex justify-center">
                          <div className="text-[10px] px-2 py-1 bg-white/5 text-gray-300 rounded-full border border-white/10">
                            {authReady ? (isAnonymous ? "住住: 专 " : "住住: 专") : "转 转专转..."}
                          </div>
                        </div>
                
                        <div className="relative mx-auto w-32 h-32">
                          <label className="cursor-pointer block w-full h-full rounded-full border-4 border-dashed border-gray-700 hover:border-pink-500 overflow-hidden transition-colors">
                            {imagePreview ? <img src={imagePreview} className="w-full h-full object-cover" /> : <Camera className="w-full h-full p-8 text-gray-600" />}
                            <input type="file" accept="image/*" onChange={handleImageUpload} className="hidden" />
                          </label>
                        </div>
                
                        <input
                          type="text"
                          value={name}
                          onChange={(e) => setName(e.target.value)}
                          placeholder="砖 砖"
                          className="w-full bg-gray-900 border border-gray-700 rounded-xl p-4 text-center text-xl focus:border-pink-500 outline-none"
                        />
                
                        <div className="flex gap-2 justify-center">
                          {[{ id: "male", l: "专" }, { id: "female", l: "砖" }, { id: "other", l: "专" }].map((o) => (
                            <button
                              key={o.id}
                              onClick={() => setGender(o.id as any)}
                              className={`px-4 py-2 rounded-lg border ${gender === o.id ? "bg-pink-600 border-pink-500" : "border-gray-800"}`}
                            >
                              {o.l}
                            </button>
                          ))}
                        </div>
                
                        <button
                          onClick={handleJoin}
                          disabled={loading}
                          className="w-full bg-pink-600 py-4 rounded-xl font-black text-xl shadow-lg disabled:opacity-50"
                        >
                          {loading ? <Loader2 className="animate-spin mx-auto" /> : " 转!"}
                        </button>
                
                        {!gameState?.session_id && (
                          <div className="text-xs text-yellow-300/80 bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-3">
                             session_id 专 注. 专 爪专 转专 拽.
                          </div>
                        )}
                      </div>
                    </div>
                  );
                }
                
                export default function PlayerJoinPage() {
                  return (
                    <Suspense fallback={<div className="bg-black h-screen text-white flex items-center justify-center">注...</div>}>
                      <GameController />
                    </Suspense>
                  );
                }

        Folder: lib
            File: supabase.ts
                Code:
                // truth-or-dare-ai\src\app\lib\supabase.ts
                
                import { createClient } from '@supabase/supabase-js';
                
                // 砖驻转 专转 砖转 住 (注 住 拽专   -TS 砖 拽 )
                const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
                const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;
                
                export const supabase = createClient(supabaseUrl, supabaseKey);

        Folder: login
            File: page.tsx
                Code:
                // truth-or-dare-ai\src\app\login\page.tsx
                
                "use client";
                
                import React, { useState } from "react";
                import { useRouter } from "next/navigation";
                import { supabase } from "@/app/lib/supabase";
                import { motion } from "framer-motion";
                import { Lock, Mail, ArrowRight, Loader2, PartyPopper } from "lucide-react";
                import Link from "next/link";
                
                export default function LoginPage() {
                  const router = useRouter();
                  const [email, setEmail] = useState("");
                  const [password, setPassword] = useState("");
                  const [loading, setLoading] = useState(false);
                  const [error, setError] = useState<string | null>(null);
                
                  const handleLogin = async (e: React.FormEvent) => {
                    e.preventDefault();
                    setLoading(true);
                    setError(null);
                
                    try {
                      const { error } = await supabase.auth.signInWithPassword({
                        email,
                        password,
                      });
                
                      if (error) throw error;
                
                      // 爪 - 注专 注 专砖
                      router.push("/");
                      router.refresh();
                    } catch (err: any) {
                      setError(err.message === "Invalid login credentials" ? "驻专 砖, 住 砖" : err.message);
                    } finally {
                      setLoading(false);
                    }
                  };
                
                  return (
                    <div className="min-h-screen bg-black text-white flex flex-col items-center justify-center p-6 relative overflow-hidden">
                      {/* Background Ambience */}
                      <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-900/30 via-black to-black z-0 pointer-events-none" />
                      
                      <motion.div 
                        initial={{ scale: 0.9, opacity: 0 }}
                        animate={{ scale: 1, opacity: 1 }}
                        className="w-full max-w-md bg-white/5 backdrop-blur-xl border border-white/10 p-8 rounded-3xl shadow-2xl z-10"
                      >
                        <div className="text-center mb-8">
                          <PartyPopper className="w-16 h-16 mx-auto text-pink-500 mb-4" />
                          <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-500">
                            专 砖
                          </h1>
                          <p className="text-gray-400 mt-2">住 注专转  转 转 住</p>
                        </div>
                
                        <form onSubmit={handleLogin} className="space-y-6">
                          <div className="space-y-2">
                            <label className="text-xs font-bold uppercase tracking-widest text-gray-500"></label>
                            <div className="relative">
                              <input
                                type="email"
                                required
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                className="w-full bg-black/50 border border-gray-700 rounded-xl p-4 pl-12 focus:border-pink-500 focus:ring-1 focus:ring-pink-500 transition-all outline-none"
                                placeholder="you@party.com"
                              />
                              <Mail className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500" size={20} />
                            </div>
                          </div>
                
                          <div className="space-y-2">
                            <label className="text-xs font-bold uppercase tracking-widest text-gray-500">住住</label>
                            <div className="relative">
                              <input
                                type="password"
                                required
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full bg-black/50 border border-gray-700 rounded-xl p-4 pl-12 focus:border-pink-500 focus:ring-1 focus:ring-pink-500 transition-all outline-none"
                                placeholder="⑩⑩⑩⑩⑩⑩⑩"
                              />
                              <Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500" size={20} />
                            </div>
                          </div>
                
                          {error && (
                            <div className="bg-red-500/10 border border-red-500/50 text-red-400 p-3 rounded-xl text-sm text-center">
                              {error}
                            </div>
                          )}
                
                          <button
                            type="submit"
                            disabled={loading}
                            className="w-full bg-gradient-to-r from-pink-600 to-purple-600 p-4 rounded-xl font-bold text-lg hover:shadow-[0_0_20px_rgba(236,72,153,0.4)] transition-all flex items-center justify-center gap-2 disabled:opacity-50"
                          >
                            {loading ? <Loader2 className="animate-spin" /> : <>转专 <ArrowRight size={20} /></>}
                          </button>
                        </form>
                
                        <div className="mt-8 text-center text-gray-400 text-sm">
                          注   砖?{" "}
                          <Link href="/register" className="text-pink-400 hover:text-pink-300 font-bold underline decoration-pink-500/30 hover:decoration-pink-500">
                            专砖 
                          </Link>
                        </div>
                      </motion.div>
                    </div>
                  );
                }

        Folder: register
            File: page.tsx
                Code:
                "use client";
                
                import React, { useState } from "react";
                import { useRouter } from "next/navigation";
                import { supabase } from "@/app/lib/supabase";
                import { motion } from "framer-motion";
                import { Lock, Mail, ArrowRight, Loader2, Sparkles } from "lucide-react";
                import Link from "next/link";
                
                export default function RegisterPage() {
                  const router = useRouter();
                  const [email, setEmail] = useState("");
                  const [password, setPassword] = useState("");
                  const [loading, setLoading] = useState(false);
                  const [error, setError] = useState<string | null>(null);
                
                  const handleRegister = async (e: React.FormEvent) => {
                    e.preventDefault();
                    setLoading(true);
                    setError(null);
                
                    try {
                      const { error } = await supabase.auth.signUp({
                        email,
                        password,
                      });
                
                      if (error) throw error;
                
                      // 爪 - 注专 注 专砖 ( 注 专转 驻专驻  转专爪 注转)
                      router.push("/");
                      router.refresh();
                    } catch (err: any) {
                      setError(err.message);
                    } finally {
                      setLoading(false);
                    }
                  };
                
                  return (
                    <div className="min-h-screen bg-black text-white flex flex-col items-center justify-center p-6 relative overflow-hidden">
                      <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-purple-900/30 via-black to-black z-0 pointer-events-none" />
                      
                      <motion.div 
                        initial={{ scale: 0.9, opacity: 0 }}
                        animate={{ scale: 1, opacity: 1 }}
                        className="w-full max-w-md bg-white/5 backdrop-blur-xl border border-white/10 p-8 rounded-3xl shadow-2xl z-10"
                      >
                        <div className="text-center mb-8">
                          <Sparkles className="w-16 h-16 mx-auto text-cyan-400 mb-4 animate-pulse" />
                          <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500">
                            爪专祝 砖拽
                          </h1>
                          <p className="text-gray-400 mt-2">爪专 砖 砖专 转 住专 砖</p>
                        </div>
                
                        <form onSubmit={handleRegister} className="space-y-6">
                          <div className="space-y-2">
                            <label className="text-xs font-bold uppercase tracking-widest text-gray-500"></label>
                            <div className="relative">
                              <input
                                type="email"
                                required
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                className="w-full bg-black/50 border border-gray-700 rounded-xl p-4 pl-12 focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition-all outline-none"
                                placeholder="you@party.com"
                              />
                              <Mail className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500" size={20} />
                            </div>
                          </div>
                
                          <div className="space-y-2">
                            <label className="text-xs font-bold uppercase tracking-widest text-gray-500">住住</label>
                            <div className="relative">
                              <input
                                type="password"
                                required
                                minLength={6}
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full bg-black/50 border border-gray-700 rounded-xl p-4 pl-12 focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition-all outline-none"
                                placeholder="驻转 6 转"
                              />
                              <Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500" size={20} />
                            </div>
                          </div>
                
                          {error && (
                            <div className="bg-red-500/10 border border-red-500/50 text-red-400 p-3 rounded-xl text-sm text-center">
                              {error}
                            </div>
                          )}
                
                          <button
                            type="submit"
                            disabled={loading}
                            className="w-full bg-gradient-to-r from-cyan-600 to-purple-600 p-4 rounded-xl font-bold text-lg hover:shadow-[0_0_20px_rgba(8,145,178,0.4)] transition-all flex items-center justify-center gap-2 disabled:opacity-50"
                          >
                            {loading ? <Loader2 className="animate-spin" /> : <>专砖 注砖 <ArrowRight size={20} /></>}
                          </button>
                        </form>
                
                        <div className="mt-8 text-center text-gray-400 text-sm">
                          专 砖  砖?{" "}
                          <Link href="/login" className="text-cyan-400 hover:text-cyan-300 font-bold underline decoration-cyan-500/30 hover:decoration-cyan-500">
                            转专 
                          </Link>
                        </div>
                      </motion.div>
                    </div>
                  );
                }

